name: ci

on: 
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v1
      
      - name: 'Write Config & Key Files'
        run: |
         mkdir ~/.oci
         echo "[DEFAULT]" >> ~/.oci/config
         echo "user=${{secrets.OCI_USER_OCID}}" >> ~/.oci/config
         echo "fingerprint=${{secrets.OCI_FINGERPRINT}}" >> ~/.oci/config
         echo "pass_phrase=${{secrets.OCI_PASSPHRASE}}" >> ~/.oci/config
         echo "region=${{secrets.OCI_REGION}}" >> ~/.oci/config
         echo "tenancy=${{secrets.OCI_TENANCY_OCID}}" >> ~/.oci/config
         echo "key_file=~/.oci/key.pem" >> ~/.oci/config
         echo "${{secrets.OCI_KEY_FILE}}" >> ~/.oci/key.pem
      - name: 'Install OCI CLI'
        run: |
         curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh
         chmod +x install.sh
         ./install.sh --accept-all-defaults
      - name: 'Create Instance'
        run: |
          echo "::set-env name=INSTANCE_OCID::$( \
          oci compute instance launch \
            --compartment-id ${{secrets.VM_COMPARTMENT_OCID}} \
            --availability-domain ${{secrets.VM_AVAILABILITY_DOMAIN}} \
            --shape ${{secrets.VM_SHAPE}} \
            --assign-public-ip true \
            --display-name cicd-demo \
            --image-id ${{secrets.VM_CUSTOM_IMAGE_OCID}} \
            --subnet-id ${{secrets.VM_SUBNET_OCID}} \
            --wait-for-state RUNNING \
            --query "data.id" \
            --raw-output \
          )"
